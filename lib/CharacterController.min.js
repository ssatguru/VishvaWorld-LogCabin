var org;!function(t){!function(t){!function(t){!function(t){var i=BABYLON.Vector3,e=BABYLON.Ray,s=function(){function t(t,s,o){var r=this;this.walkSpeed=3,this.runSpeed=2*this.walkSpeed,this.backSpeed=this.walkSpeed/2,this.jumpSpeed=2*this.walkSpeed,this.leftSpeed=this.walkSpeed/2,this.rightSpeed=this.walkSpeed/2,this.gravity=9.8,this.minSlopeLimit=30,this.maxSlopeLimit=45,this.sl=Math.PI*this.minSlopeLimit/180,this.sl2=Math.PI*this.maxSlopeLimit/180,this._stepOffset=.25,this._vMoveTot=0,this._vMovStartPos=new i(0,0,0),this.walk=new a("walk"),this.walkBack=new a("walkBack"),this.idle=new a("idle"),this.run=new a("run"),this.jump=new a("jump"),this.fall=new a("fall"),this.turnLeft=new a("turnLeft"),this.turnRight=new a("turnRight"),this.strafeLeft=new a("strafeLeft"),this.strafeRight=new a("strafeRight"),this.slideBack=new a("slideBack"),this.anims=[this.walk,this.walkBack,this.idle,this.run,this.jump,this.fall,this.turnLeft,this.turnRight,this.strafeLeft,this.strafeRight,this.slideBack],this.walkKey="W",this.walkBackKey="S",this.turnLeftKey="A",this.turnRightKey="D",this.strafeLeftKey="Q",this.strafeRightKey="E",this.jumpKey="32",this.walkCode=38,this.walkBackCode=40,this.turnLeftCode=37,this.turnRightCode=39,this.strafeLeftCode=0,this.strafeRightCode=0,this.jumpCode=32,this.elasticCamera=!0,this.cameraTarget=new i(0,0,0),this.noFirstPerson=!1,this.started=!1,this._stopAnim=!1,this.prevAnim=null,this.avStartPos=new i(0,0,0),this.grounded=!1,this.freeFallDist=0,this.fallFrameCountMin=50,this.fallFrameCount=0,this.inFreeFall=!1,this.wasWalking=!1,this.wasRunning=!1,this.jumpStartPosY=0,this.jumpTime=0,this.movFallTime=0,this.idleFallTime=0,this.groundFrameCount=0,this.groundFrameMax=10,this.savedCameraCollision=!0,this.ray=new e(i.Zero(),i.One(),1),this.rayDir=i.Zero(),this.cameraSkin=.5,this.skip=0,this.move=!1,this.avatar=t,this.scene=o,this.skeleton=t.skeleton,null!=this.skeleton&&this.checkAnims(this.skeleton),this.camera=s,this.savedCameraCollision=this.camera.checkCollisions,this.key=new h,window.addEventListener("keydown",function(t){return r.onKeyDown(t)},!1),window.addEventListener("keyup",function(t){return r.onKeyUp(t)},!1),this.renderer=function(){r.moveAVandCamera()}}return t.prototype.setAvatar=function(t){this.avatar=t},t.prototype.setAvatarSkeleton=function(t){this.skeleton=t,this.checkAnims(t)},t.prototype.setSlopeLimit=function(t,i){this.minSlopeLimit=t,this.maxSlopeLimit=i,this.sl=Math.PI*t/180,this.sl2=Math.PI*this.maxSlopeLimit/180},t.prototype.setStepOffset=function(t){this._stepOffset=t},t.prototype.setWalkSpeed=function(t){this.walkSpeed=t},t.prototype.setRunSpeed=function(t){this.runSpeed=t},t.prototype.setBackSpeed=function(t){this.backSpeed=t},t.prototype.setJumpSpeed=function(t){this.jumpSpeed=t},t.prototype.setLeftSpeed=function(t){this.leftSpeed=t},t.prototype.setRightSpeed=function(t){this.rightSpeed=t},t.prototype.setGravity=function(t){this.gravity=t},t.prototype.setAnim=function(t,i,e,s){null!=this.skeleton&&(t.name=i,t.rate=e,t.loop=s,null!=this.skeleton.getAnimationRange(t.name)?t.exist=!0:t.exist=!1)},t.prototype.setWalkAnim=function(t,i,e){this.setAnim(this.walk,t,i,e)},t.prototype.setRunAnim=function(t,i,e){this.setAnim(this.run,t,i,e)},t.prototype.setWalkBackAnim=function(t,i,e){this.setAnim(this.walkBack,t,i,e)},t.prototype.setSlideBackAnim=function(t,i,e){this.setAnim(this.slideBack,t,i,e)},t.prototype.setIdleAnim=function(t,i,e){this.setAnim(this.idle,t,i,e)},t.prototype.setTurnRightAnim=function(t,i,e){this.setAnim(this.turnRight,t,i,e)},t.prototype.setTurnLeftAnim=function(t,i,e){this.setAnim(this.turnLeft,t,i,e)},t.prototype.setStrafeRightAnim=function(t,i,e){this.setAnim(this.strafeRight,t,i,e)},t.prototype.setSrafeLeftAnim=function(t,i,e){this.setAnim(this.strafeLeft,t,i,e)},t.prototype.setJumpAnim=function(t,i,e){this.setAnim(this.jump,t,i,e)},t.prototype.setFallAnim=function(t,i,e){this.setAnim(this.fall,t,i,e)},t.prototype.setWalkKey=function(t){this.walkKey=t},t.prototype.setWalkBackKey=function(t){this.walkBackKey=t},t.prototype.setTurnLeftKey=function(t){this.turnLeftKey=t},t.prototype.setTurnRightKey=function(t){this.turnRightKey=t},t.prototype.setStrafeLeftKey=function(t){this.strafeLeftKey=t},t.prototype.setStrafeRightKey=function(t){this.strafeRightKey=t},t.prototype.setJumpKey=function(t){this.jumpKey=t},t.prototype.setWalkCode=function(t){this.walkCode=t},t.prototype.setWalkBackCode=function(t){this.walkBackCode=t},t.prototype.setTurnLeftCode=function(t){this.turnLeftCode=t},t.prototype.setTurnRightCode=function(t){this.turnRightCode=t},t.prototype.setStrafeLeftCode=function(t){this.strafeLeftCode=t},t.prototype.setStrafeRightCode=function(t){this.strafeRightCode=t},t.prototype.setJumpCode=function(t){this.jumpCode=t},t.prototype.setCameraElasticity=function(t){this.elasticCamera=t},t.prototype.setCameraTarget=function(t){this.cameraTarget.copyFrom(t)},t.prototype.cameraCollisionChanged=function(){this.savedCameraCollision=this.camera.checkCollisions},t.prototype.setNoFirstPerson=function(t){this.noFirstPerson=t},t.prototype.checkAnims=function(t){for(var i=0,e=this.anims;i<e.length;i++){var s=e[i];null!=t.getAnimationRange(s.name)&&(s.exist=!0)}},t.prototype.start=function(){this.started||(this.started=!0,this.key.reset(),this.movFallTime=0,this.idleFallTime=.001,this.grounded=!1,this.updateTargetValue(),this.scene.registerBeforeRender(this.renderer),this.scene)},t.prototype.stop=function(){this.started&&(this.started=!1,this.scene.unregisterBeforeRender(this.renderer),this.prevAnim=null)},t.prototype.pauseAnim=function(){this._stopAnim=!0},t.prototype.resumeAnim=function(){this._stopAnim=!1},t.prototype.moveAVandCamera=function(){this.avStartPos.copyFrom(this.avatar.position);var t=null,i=this.scene.getEngine().getDeltaTime()/1e3;this.key.jump&&!this.inFreeFall?(this.grounded=!1,this.idleFallTime=0,t=this.doJump(i)):this.anyMovement()||this.inFreeFall?(this.grounded=!1,this.idleFallTime=0,t=this.doMove(i)):this.inFreeFall||(t=this.doIdle(i)),this._stopAnim||null!=t&&null!==this.skeleton&&this.prevAnim!==t&&(t.exist&&this.skeleton.beginAnimation(t.name,t.loop,t.rate),this.prevAnim=t),this.updateTargetValue()},t.prototype.doJump=function(t){var e=null;e=this.jump,0===this.jumpTime&&(this.jumpStartPosY=this.avatar.position.y);var s=this.jumpSpeed-this.gravity*this.jumpTime,a=s*t-.5*this.gravity*t*t;this.jumpTime=this.jumpTime+t;var h,o=0;if(this.avatar.rotation.y=-4.69-this.camera.alpha,this.wasRunning||this.wasWalking?(this.wasRunning?o=this.runSpeed*t:this.wasWalking&&(o=this.walkSpeed*t),h=this.moveVector.clone(),h.y=0,h=h.normalize(),h.scaleToRef(o,h),h.y=a):h=new i(0,a,0),this.avatar.moveWithCollisions(h),a<0)if(this.avatar.position.y>this.avStartPos.y||this.avatar.position.y===this.avStartPos.y&&h.length()>.001)this.endJump();else if(this.avatar.position.y<this.jumpStartPosY){var r=this.avatar.position.subtract(this.avStartPos);this.areVectorsEqual(r,h,.001)||this.verticalSlope(r)<=this.sl&&this.endJump()}return e},t.prototype.endJump=function(){this.key.jump=!1,this.jumpTime=0,this.wasWalking=!1,this.wasRunning=!1},t.prototype.areVectorsEqual=function(t,i,e){return Math.abs(t.x-i.x)<e&&Math.abs(t.y-i.y)<e&&Math.abs(t.z-i.z)<e},t.prototype.verticalSlope=function(t){return Math.atan(Math.abs(t.y/Math.sqrt(t.x*t.x+t.z*t.z)))},t.prototype.doMove=function(t){var i=this.movFallTime*this.gravity;this.freeFallDist=i*t+this.gravity*t*t/2,this.movFallTime=this.movFallTime+t;var e=!1,s=null;if(this.inFreeFall)this.moveVector.y=-this.freeFallDist,e=!0;else if(this.wasWalking=!1,this.wasRunning=!1,this.key.forward){var a=0;this.key.shift?(this.wasRunning=!0,a=this.runSpeed*t,s=this.run):(this.wasWalking=!0,a=this.walkSpeed*t,s=this.walk),this.moveVector=this.avatar.calcMovePOV(0,-this.freeFallDist,a),e=!0}else this.key.backward?(this.moveVector=this.avatar.calcMovePOV(0,-this.freeFallDist,-this.backSpeed*t),s=this.walkBack,e=!0):this.key.stepLeft?(s=this.strafeLeft,this.moveVector=this.avatar.calcMovePOV(-this.leftSpeed*t,-this.freeFallDist,0),e=!0):this.key.stepRight&&(s=this.strafeRight,this.moveVector=this.avatar.calcMovePOV(this.rightSpeed*t,-this.freeFallDist,0),e=!0);if(this.key.stepLeft||this.key.stepRight||(this.key.turnLeft?(this.camera.alpha=this.camera.alpha+.022,e||(this.avatar.rotation.y=-4.69-this.camera.alpha,s=this.turnLeft)):this.key.turnRight&&(this.camera.alpha=this.camera.alpha-.022,e||(this.avatar.rotation.y=-4.69-this.camera.alpha,s=this.turnRight))),e&&(this.avatar.rotation.y=-4.69-this.camera.alpha,this.moveVector.length()>.001))if(this.avatar.moveWithCollisions(this.moveVector),this.avatar.position.y>this.avStartPos.y){var h=this.avatar.position.subtract(this.avStartPos),o=this.verticalSlope(h);o>=this.sl2?this._stepOffset>0?(0==this._vMoveTot&&this._vMovStartPos.copyFrom(this.avStartPos),this._vMoveTot=this._vMoveTot+(this.avatar.position.y-this.avStartPos.y),this._vMoveTot>this._stepOffset&&(this._vMoveTot=0,this.avatar.position.copyFrom(this._vMovStartPos),this.endFreeFall())):(this.avatar.position.copyFrom(this.avStartPos),this.endFreeFall()):(this._vMoveTot=0,o>this.sl?(this.fallFrameCount=0,this.inFreeFall=!1):this.endFreeFall())}else if(this.avatar.position.y<this.avStartPos.y){var h=this.avatar.position.subtract(this.avStartPos);this.areVectorsEqual(h,this.moveVector,.001)?(this.inFreeFall=!0,++this.fallFrameCount>this.fallFrameCountMin&&(s=this.fall)):this.verticalSlope(h)<=this.sl?this.endFreeFall():(this.fallFrameCount=0,this.inFreeFall=!1)}else this.endFreeFall();return s},t.prototype.endFreeFall=function(){this.movFallTime=0,this.fallFrameCount=0,this.inFreeFall=!1},t.prototype.doIdle=function(t){if(this.grounded)return this.idle;this.wasWalking=!1,this.wasRunning=!1,this.movFallTime=0;var e=this.idle;if(this.fallFrameCount=0,0===t)this.freeFallDist=5;else{var s=this.idleFallTime*this.gravity;this.freeFallDist=s*t+this.gravity*t*t/2,this.idleFallTime=this.idleFallTime+t}if(this.freeFallDist<.01)return e;var a=new i(0,-this.freeFallDist,0);if(this.avatar.rotation.y=-4.69-this.camera.alpha,this.avatar.moveWithCollisions(a),this.avatar.position.y>this.avStartPos.y||this.avatar.position.y===this.avStartPos.y)this.groundIt();else if(this.avatar.position.y<this.avStartPos.y){var h=this.avatar.position.subtract(this.avStartPos);this.areVectorsEqual(h,a,.001)||(this.verticalSlope(h)<=this.sl?(this.groundIt(),this.avatar.position.copyFrom(this.avStartPos)):(this.unGroundIt(),e=this.slideBack))}return e},t.prototype.groundIt=function(){++this.groundFrameCount>this.groundFrameMax&&(this.grounded=!0,this.idleFallTime=0)},t.prototype.unGroundIt=function(){this.grounded=!1,this.groundFrameCount=0},t.prototype.updateTargetValue=function(){0==this._vMoveTot&&this.avatar.position.addToRef(this.cameraTarget,this.camera.target),this.camera.radius>this.camera.lowerRadiusLimit&&this.elasticCamera&&this.snapCamera(),this.camera.radius<=this.camera.lowerRadiusLimit?this.noFirstPerson||(this.avatar.visibility=0,this.camera.checkCollisions=!1):(this.avatar.visibility=1,this.camera.checkCollisions=this.savedCameraCollision)},t.prototype.snapCamera=function(){var t=this;this.camera.position.subtractToRef(this.camera.target,this.rayDir),this.ray.origin=this.camera.target,this.ray.length=this.rayDir.length(),this.ray.direction=this.rayDir.normalize();var i=this.scene.pickWithRay(this.ray,function(i){return!(i==t.avatar||!i.checkCollisions)},!0);if(i.hit)if(this.camera.checkCollisions){var e=this.camera.target.subtract(i.pickedPoint).normalize().scale(this.cameraSkin);i.pickedPoint.addToRef(e,this.camera.position)}else{var s=i.pickedPoint.subtract(this.camera.target).length();this.camera.radius=s-this.cameraSkin}},t.prototype.anyMovement=function(){return this.key.forward||this.key.backward||this.key.turnLeft||this.key.turnRight||this.key.stepLeft||this.key.stepRight},t.prototype.onKeyDown=function(t){var i=t,e=i.keyCode,s=String.fromCharCode(e);s===this.jumpKey||e===this.jumpCode?this.key.jump=!0:16===e?this.key.shift=!0:s===this.walkKey||e===this.walkCode?this.key.forward=!0:s===this.turnLeftKey||e===this.turnLeftCode?this.key.turnLeft=!0:s===this.turnRightKey||e===this.turnRightCode?this.key.turnRight=!0:s===this.walkBackKey||e===this.walkBackCode?this.key.backward=!0:s===this.strafeLeftKey||e===this.strafeLeftCode?this.key.stepLeft=!0:s!==this.strafeRightKey&&e!==this.strafeRightCode||(this.key.stepRight=!0),this.move=this.anyMovement()},t.prototype.onKeyUp=function(t){var i=t,e=i.keyCode,s=String.fromCharCode(e);16===e?this.key.shift=!1:s===this.walkKey||e===this.walkCode?this.key.forward=!1:s===this.turnLeftKey||e===this.turnLeftCode?this.key.turnLeft=!1:s===this.turnRightKey||e===this.turnRightCode?this.key.turnRight=!1:s===this.walkBackKey||e===this.walkBackCode?this.key.backward=!1:s===this.strafeLeftKey||e===this.strafeLeftCode?this.key.stepLeft=!1:s!==this.strafeRightKey&&e!==this.strafeRightCode||(this.key.stepRight=!1),this.move=this.anyMovement()},t}();t.CharacterController=s;var a=function(){function t(t){this.loop=!0,this.rate=1,this.exist=!1,this.name=t}return t}();t.AnimData=a;var h=function(){function t(){this.reset()}return t.prototype.reset=function(){this.forward=!1,this.backward=!1,this.turnRight=!1,this.turnLeft=!1,this.stepRight=!1,this.stepLeft=!1,this.jump=!1,this.shift=!1},t}();t.Key=h}(t.component||(t.component={}))}(t.babylonjs||(t.babylonjs={}))}(t.ssatguru||(t.ssatguru={}))}(org||(org={}));